# ShopifyMetrics

Performance metrics implemented with StatsD are used widely across services at
Shopify. The standard metrics should be documented and following strong conventions.

*ShopifyMetrics* aims to provide standard middlewares and instrumentation tooling for Rails.

See [design document](https://docs.google.com/document/d/1qGyNXaZTpP1T6-e5wUQ2cyXvsfKGZEo6pikipnNYa_4)

## Metrics

ShopifyMetrics relies on the [statsd-instrument](https://github.com/Shopify/statsd-instrument) gem to send the metrics.

The global StatsD metric name prefix is set to `AppName.` (unless it's set by the application). The Rails environment is
sent as a tag called `environment`.

See [metrics doc](METRICS.md) for more information about the statsd metrics produced by ShopifyMetrics.

## Features

- Request statistics: `ShopifyMetrics::Middlewares::RequestMetrics`
- Rack statistics: `ShopifyMetrics::Middlewares::RaindropsMetrics`
- Puma metrics: `puma/plugin/shopify_metrics` (required structure for Puma plugins)
- Sidekiq statistics:
  * `ShopifyMetrics::Middlewares::SidekiqMiddleware`
  * `ShopifyMetrics::Jobs::SidekiqPerformanceMetrics`
- Client instrumentation for caching and queuing datastores:
  * `dalli` and `memcached` Memcached clients
  * `redis` client
- Process statistics:
  * `ShopifyMetrics:ProcessCollector`

### Alternate ways of reporting events:
Out of the box, if your application doesn't define a `StatsD.prefix`, on including this gem, it will add the
middlewares listed above and start generating events to `StatsD`, using a metric name with a prefix: `YourAppName.`.

The installation steps listed below show you how to get that setup.

### Roadmap:

- ActiveJob statistics: `ShopifyMetrics::Middlewares::ActiveJobMetrics`

## Installation

*ShopifyMetrics* will be automatically installed and enabled by the
**ShopifyCloud** and the **ShopifyAppPlatform** gem.

**Manual installation**: add the following to your application:

Gemfile:
```ruby
source 'https://packages.shopify.io/shopify/gems' do
  gem 'shopify_metrics'
end
```

dev.yml:
```yml
- bundler:
    tokens: true
```

### Application specific tags
Optionally, to include custom application specific tags in the `StatsD` events generated by the middlewares included
in this gem, have a file in you Rails application like. `config/shopify_metrics.yml` of the form:
```yaml
---
development: &development
  tags:
    rails_env: <%= Rails.env %>
    your_custom_tag1: custom_value1
    your_custom_tag2: custom_value2
production:
  <<: *development
staging:
  <<: *development
test:
  <<: *development
```

Finally, in your app, set up a custom configuration, like so:
```ruby
Rails.application.config.x.shopify_metrics_tags = config_for(:shopify_metrics)["tags"]
```

The gem will include your tags in the metrics reported via `StatsD` in the middlewares.

### Request middleware

You can disable this feature using:

```
Rails.application.config.x.shopify_metrics_disable_request_metrics_middleware = true
```

### Controller specific request metrics tags
Optionally, to include specific request metric tags per controller, have a `shopify_metrics_tags` method in your controller of the form
```ruby
def shopify_metrics_tags
  { controller_type: 'storefront' }
end
```
The gem will include your tags in the metrics reported via `StatsD` in the middlewares.

You can disable this feature using:

```
Rails.application.config.x.shopify_metrics_disable_action_controller_tags = true
```

### Puma metrics

This gem automatically injects `plugin(:shopify_metrics)` in the default Puma configuration to emit metrics. You can disable this feature using:

```
Rails.application.config.x.shopify_metrics_disable_puma_plugin = true
```

### Sidekiq middleware

You can disable this feature using:

```
Rails.application.config.x.shopify_metrics_disable_sidekiq_middleware = true
```

### Using the SidekiqPerformanceMetrics job

This gem will not try to schedule this job by default. It's up to the developer to schedule the job if they so choose.

It's also up to the developer of the app to decide how often to run this job.

By default this job will be scheduled on the default queue.
```ruby
ShopifyMetrics::Jobs::SidekiqPerformanceMetrics.perform_async
```

Alternatively, Sidekiq allows passing the queue as a parameter when scheduling the job:
```ruby
ShopifyMetrics::Jobs::SidekiqPerformanceMetrics.set(queue: 'high_priority').perform_async
```

### Spawn Raindrops monitor thread

To avoid the rather expensive system calls to monitor the `raindrops.*` metrics,
we recommend spawning a thread in the master process to monitor this instead of
doing it on each request in a middleware. It _will_ work without this (to be
backwards compatible) but this is what we do in Core.

```ruby
# Puma and Unicorn both support this syntax to run code in the Master process.
before_fork do
  ShopifyMetrics::RaindropsMonitor.init
end

# In config/application.rb (initializers run too late for this):
Rails.application.config.x.shopify_metrics_disable_raindrops_middleware = true
```

### Collecting Process Metrics

`ShopifyMetrics::ProcessCollector` is used to collect per-process stats by logging
the metrics in a Splunk friendly format.

`[ShopifyMetrics::ProcessCollector] container_id="hostname" pid="30595" environment="test" type="ruby" rss="1234" threads_count="1" allocated_objects_count="1511051"`

Currently, the following stats are being collected:

1. Resident Set Size
1. Number of threads
1. Total number of objects allocated

To start collecting per-process stats, call `ShopifyMetrics::ProcessCollector.init`
from within the process. By default, the `type` key in the log message is `ruby`
but you can override it by passing the `type` keyword argument when
starting the collector `ShopifyMetrics::ProcessCollector.init(type: 'unicorn')`.

For use in Unicorn or Puma (cluster mode), you can start the collector as per the following
example:

```ruby
# Unicorn
after_fork do
  ShopifyMetrics::ProcessCollector.init(type: 'unicorn')
end

# Puma
on_worker_boot do
  ShopifyMetrics::ProcessCollector.init(type: 'puma')
end
```
