containers:
  default:
    docker: circleci/ruby:2.5.5

steps:
  - label: Tests Rails 5.0
    timeout: 5m
    run:
      - sudo apt-get update && sudo apt-get -y install libsasl2-dev
      - gem install bundler
      - bundle: ~
      - bundle exec rspec
      - STATSD_USE_NEW_CLIENT=1 bundle exec rspec
    services:
      toxiproxy.shopify-metrics:
        image: "shopify/toxiproxy:2.1.3"
        ports:
          - "8474"
          - "21212-21213"
      memcached.shopify-metrics:
        image: "gcr.io/shopify-docker-images/cloud/memcached:1.0"
        ports:
          - "11211"
      redis.shopify-metrics:
        image: "gcr.io/shopify-docker-images/cloud/redis:1.1"
        ports:
          - "6379"
  - label: Ruby Lint
    run:
      - sudo apt-get update && sudo apt-get -y install libsasl2-dev
      - gem install bundler
      - bundle: ~
      - bundle exec rubocop
    cache:
      - tmp/rubocop
    timeout: 5m
